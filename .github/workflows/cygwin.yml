name: cygwin-dll

on:
  push:
    branches:
      - main

permissions:
  contents: write 

jobs:
  build-dll:
    runs-on: ubuntu-latest
    container: fedora:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-cygwin
            pkgarch: 64
    name: Fedora cross ${{ matrix.target }}

    steps:
      - uses: actions/checkout@v5

      # install build tools
      - name: Install build tools
        run: |
          dnf install -y autoconf automake gawk make patch perl \
            mingw${{ matrix.pkgarch }}-gcc-c++ \
            mingw${{ matrix.pkgarch }}-winpthreads-static \
            mingw${{ matrix.pkgarch }}-zlib-static

      # enable 'dnf copr'
      - name: Enable 'dnf copr'
        run: dnf install -y dnf-plugins-core

      # install cross-Cygwin toolchain
      - name: Install cross-Cygwin toolchain and cocom
        run: |
          dnf copr enable -y yselkowitz/cygwin
          dnf install -y \
            cygwin${{ matrix.pkgarch }}-gcc-c++ \
            cygwin${{ matrix.pkgarch }}-gettext \
            cygwin${{ matrix.pkgarch }}-libbfd \
            cygwin${{ matrix.pkgarch }}-libiconv \
            cygwin${{ matrix.pkgarch }}-zlib \
            cocom

      # build DLL only
      - name: Build DLL
        run: |
          mkdir build install
          (cd winsup && ./autogen.sh)
          (cd build && ../configure --target=${{ matrix.target }} --prefix=$(realpath $(pwd)/../install) --disable-doc)
          make -C build
          # copy DLLs to release folder
          mkdir -p ../release
          find build -name "*.dll" -exec cp {} ../release/ \;

      # create GitHub Release with DLL
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.sha }}
          name: Release ${{ github.sha }}
          files: release/*.dll
